# CI/CD é…ç½®æŒ‡å—

æœ¬é¡¹ç›®åŒ…å«è‡ªåŠ¨åŒ–çš„ CI/CD æµæ°´çº¿ï¼Œå½“ OpenAPI è§„èŒƒæ–‡ä»¶å‘ç”Ÿå˜æ›´æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ API å®¢æˆ·ç«¯ä»£ç å¹¶å‘å¸ƒåˆ° npmã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **è‡ªåŠ¨è§¦å‘**: å½“ `specs/` ç›®å½•ä¸­çš„ YAML/JSON æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘
- ğŸ”¨ **è‡ªåŠ¨æ„å»º**: è‡ªåŠ¨æ„å»ºé¡¹ç›®å’Œç”Ÿæˆçš„ API å®¢æˆ·ç«¯ä»£ç 
- ğŸ“¦ **è‡ªåŠ¨å‘å¸ƒ**: è‡ªåŠ¨å‘å¸ƒç”Ÿæˆçš„åŒ…åˆ° npm ä»“åº“
- ğŸ·ï¸ **ç‰ˆæœ¬ç®¡ç†**: è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·å¹¶åˆ›å»º Git æ ‡ç­¾
- ğŸ“‹ **æ„å»ºäº§ç‰©**: ä¿å­˜ç”Ÿæˆçš„ä»£ç ä½œä¸ºæ„å»ºäº§ç‰©

## è®¾ç½®æ­¥éª¤

### 1. é…ç½® npm è®¿é—®ä»¤ç‰Œ

åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ ä»¥ä¸‹ Secretï¼š

- `NPM_TOKEN`: ä½ çš„ npm è®¿é—®ä»¤ç‰Œ

è·å– npm ä»¤ç‰Œçš„æ­¥éª¤ï¼š
```bash
# ç™»å½• npm
npm login

# åˆ›å»ºè®¿é—®ä»¤ç‰Œ
npm token create --access public
```

### 2. é…ç½®ç”Ÿæˆçš„åŒ…ä¿¡æ¯

ç¼–è¾‘ `src/generator.ts` ä¸­çš„åŒ…é…ç½®ï¼š

```typescript
private async generatePackageJson(): Promise<GeneratedFile> {
  const packageJson = {
    name: "your-api-client-name",  // ä¿®æ”¹ä¸ºä½ çš„åŒ…å
    version: "1.0.0",
    description: "Generated API client",
    // ... å…¶ä»–é…ç½®
  };
}
```

### 3. æ›´æ–° OpenAPI è§„èŒƒ

å°†ä½ çš„ OpenAPI è§„èŒƒæ–‡ä»¶æ”¾åœ¨ `specs/` ç›®å½•ä¸­ï¼š

```
specs/
â”œâ”€â”€ api-v1.yaml
â”œâ”€â”€ api-v2.yaml
â””â”€â”€ ...
```

## å·¥ä½œæµç¨‹

### è§¦å‘æ¡ä»¶

- **Push åˆ°ä¸»åˆ†æ”¯**: å½“æ¨é€åŒ…å« `specs/` ç›®å½•å˜æ›´çš„æäº¤åˆ° `main` æˆ– `master` åˆ†æ”¯
- **Pull Request**: å½“åˆ›å»ºåŒ…å« `specs/` ç›®å½•å˜æ›´çš„ PR

### æ‰§è¡Œæ­¥éª¤

1. **æ£€å‡ºä»£ç **: è·å–æœ€æ–°ä»£ç 
2. **è®¾ç½®ç¯å¢ƒ**: å®‰è£… Node.js 18
3. **å®‰è£…ä¾èµ–**: è¿è¡Œ `npm ci`
4. **æ„å»ºé¡¹ç›®**: è¿è¡Œ `npm run build`
5. **ç”Ÿæˆä»£ç **: è¿è¡Œ `npm run generate`
6. **æ„å»ºç”Ÿæˆçš„åŒ…**: åœ¨ `generated/` ç›®å½•ä¸­æ„å»º
7. **è¿è¡Œæµ‹è¯•**: å¦‚æœå­˜åœ¨æµ‹è¯•åˆ™è¿è¡Œ
8. **å‘å¸ƒåŒ…**: ä»…åœ¨ä¸»åˆ†æ”¯ä¸Šå‘å¸ƒåˆ° npm
9. **åˆ›å»ºæ ‡ç­¾**: åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
10. **ä¸Šä¼ äº§ç‰©**: ä¿å­˜ç”Ÿæˆçš„ä»£ç 

## æœ¬åœ°è„šæœ¬

é¡¹ç›®åŒ…å«ä»¥ä¸‹ CI ç›¸å…³è„šæœ¬ï¼š

```bash
# æ„å»ºå¹¶ç”Ÿæˆä»£ç 
npm run ci:build

# å‘å¸ƒç”Ÿæˆçš„åŒ…
npm run ci:publish

# å®Œæ•´çš„ CI æµç¨‹
npm run ci:full
```

## ç‰ˆæœ¬ç®¡ç†

å·¥ä½œæµä¼šè‡ªåŠ¨ç®¡ç†ç‰ˆæœ¬å·ï¼š
- **è‡ªåŠ¨ç‰ˆæœ¬æ›´æ–°**: æ¯æ¬¡å‘å¸ƒæ—¶è‡ªåŠ¨å¢åŠ  patch ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0 â†’ 1.0.1)
- **Git æäº¤**: ç‰ˆæœ¬å˜æ›´ä¼šè‡ªåŠ¨æäº¤åˆ°ä»“åº“ (å¸¦æœ‰ `[skip ci]` æ ‡è®°é¿å…å¾ªç¯è§¦å‘)
- **æ ‡ç­¾åˆ›å»º**: ä¸ºæ¯ä¸ªå‘å¸ƒç‰ˆæœ¬åˆ›å»º git æ ‡ç­¾ (ä¾‹å¦‚: v1.0.1)
- **æ ‡ç­¾æ¨é€**: è‡ªåŠ¨æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“

### æ‰‹åŠ¨ç‰ˆæœ¬ç®¡ç†

å¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶ç‰ˆæœ¬å·ï¼Œå¯ä»¥åœ¨ç”Ÿæˆçš„åŒ…ä¸­ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼š
```bash
# å¢åŠ  patch ç‰ˆæœ¬ (1.0.0 â†’ 1.0.1)
npm run version:patch

# å¢åŠ  minor ç‰ˆæœ¬ (1.0.0 â†’ 1.1.0)
npm run version:minor

# å¢åŠ  major ç‰ˆæœ¬ (1.0.0 â†’ 2.0.0)
npm run version:major
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **npm å‘å¸ƒå¤±è´¥**
   - æ£€æŸ¥ `NPM_TOKEN` æ˜¯å¦æ­£ç¡®è®¾ç½®
   - ç¡®è®¤åŒ…åæœªè¢«å ç”¨
   - æ£€æŸ¥åŒ…è®¿é—®æƒé™è®¾ç½®

2. **æ„å»ºå¤±è´¥**
   - æ£€æŸ¥ OpenAPI è§„èŒƒæ–‡ä»¶æ ¼å¼
   - ç¡®è®¤æ‰€æœ‰ä¾èµ–å·²æ­£ç¡®å®‰è£…
   - æŸ¥çœ‹æ„å»ºæ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯

3. **ç‰ˆæœ¬å†²çª**
   - æ‰‹åŠ¨æ›´æ–° `generated/package.json` ä¸­çš„ç‰ˆæœ¬å·
   - æˆ–åˆ é™¤ npm ä¸Šçš„å¯¹åº”ç‰ˆæœ¬

4. **ESM/CommonJS å…¼å®¹æ€§é”™è¯¯**
   - å¦‚æœé‡åˆ° `ERR_REQUIRE_ESM` é”™è¯¯ï¼Œé€šå¸¸æ˜¯å› ä¸ºä¾èµ–åŒ…ç‰ˆæœ¬ä¸å…¼å®¹
   - ç¡®ä¿ä½¿ç”¨ chalk v4.x è€Œä¸æ˜¯ v5.xï¼ˆv5+ ä»…æ”¯æŒ ESMï¼‰
   - æ£€æŸ¥ package.json ä¸­çš„ä¾èµ–ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®

### è°ƒè¯•æ­¥éª¤

1. æŸ¥çœ‹ GitHub Actions æ—¥å¿—
2. æœ¬åœ°è¿è¡Œ `npm run ci:full` æµ‹è¯•
3. æ£€æŸ¥ç”Ÿæˆçš„ `generated/` ç›®å½•å†…å®¹
4. éªŒè¯ OpenAPI è§„èŒƒæ–‡ä»¶æœ‰æ•ˆæ€§

## è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹è§¦å‘æ¡ä»¶

ç¼–è¾‘ `.github/workflows/ci.yml` ä¸­çš„ `on` éƒ¨åˆ†ï¼š

```yaml
on:
  push:
    paths:
      - 'specs/**/*.yaml'
      - 'src/**/*.ts'  # æ·»åŠ å…¶ä»–è§¦å‘è·¯å¾„
```

### æ·»åŠ æµ‹è¯•æ­¥éª¤

åœ¨ç”Ÿæˆçš„åŒ…ä¸­æ·»åŠ æµ‹è¯•ï¼š

```json
{
  "scripts": {
    "test": "jest",
    "test:coverage": "jest --coverage"
  }
}
```

### å¤šç¯å¢ƒå‘å¸ƒ

é…ç½®ä¸åŒåˆ†æ”¯å‘å¸ƒåˆ°ä¸åŒç¯å¢ƒï¼š

```yaml
- name: Publish to npm (staging)
  if: github.ref == 'refs/heads/develop'
  run: npm publish --tag beta
```